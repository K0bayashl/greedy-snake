<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2048 像素皮肤系统测试报告</title>
  <style>
    body {
      font-family: "Microsoft YaHei", Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    h2 {
      color: #555;
      margin-top: 30px;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-item {
      padding: 12px;
      margin: 8px 0;
      border-left: 4px solid #ddd;
      background: #f9f9f9;
    }
    .test-item.pass {
      border-left-color: #4CAF50;
      background: #f1f8f4;
    }
    .test-item.fail {
      border-left-color: #f44336;
      background: #fef1f1;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: bold;
      margin-right: 10px;
    }
    .status.pass {
      background: #4CAF50;
      color: white;
    }
    .status.fail {
      background: #f44336;
      color: white;
    }
    .bug-report {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 15px;
      margin-top: 10px;
    }
    .bug-title {
      font-weight: bold;
      color: #856404;
      margin-bottom: 8px;
    }
    .steps {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 4px;
      margin-top: 8px;
      font-family: monospace;
      font-size: 14px;
    }
    .summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .summary h2 {
      color: white;
      margin-top: 0;
    }
    .stats {
      display: flex;
      gap: 30px;
      margin-top: 15px;
    }
    .stat-item {
      flex: 1;
      text-align: center;
      padding: 15px;
      background: rgba(255,255,255,0.2);
      border-radius: 6px;
    }
    .stat-number {
      font-size: 32px;
      font-weight: bold;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    .iframe-container {
      width: 100%;
      height: 600px;
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .test-controls {
      margin-bottom: 15px;
      padding: 15px;
      background: #e3f2fd;
      border-radius: 6px;
    }
    .test-controls button {
      padding: 10px 20px;
      margin-right: 10px;
      border: none;
      border-radius: 4px;
      background: #2196F3;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .test-controls button:hover {
      background: #1976D2;
    }
    .test-controls button:active {
      background: #0D47A1;
    }
  </style>
</head>
<body>
  <h1>2048 像素皮肤系统测试报告</h1>

  <div class="summary">
    <h2>测试总结</h2>
    <div class="stats">
      <div class="stat-item">
        <div class="stat-number" id="total-tests">0</div>
        <div class="stat-label">总测试数</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="passed-tests" style="color: #4CAF50;">0</div>
        <div class="stat-label">通过</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="failed-tests" style="color: #f44336;">0</div>
        <div class="stat-label">失败</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="pass-rate">0%</div>
        <div class="stat-label">通过率</div>
      </div>
    </div>
  </div>

  <div class="test-section">
    <h2>测试控制台</h2>
    <div class="test-controls">
      <button onclick="runAllTests()">运行所有测试</button>
      <button onclick="openGame()">打开游戏进行手动测试</button>
      <button onclick="exportReport()">导出测试报告</button>
    </div>
    <div class="iframe-container" id="game-container" style="display: none;">
      <iframe id="game-frame" src="index.html"></iframe>
    </div>
  </div>

  <div class="test-section">
    <h2>1. 功能测试</h2>
    <div id="functional-tests"></div>
  </div>

  <div class="test-section">
    <h2>2. 修复验证</h2>
    <div id="fix-verification"></div>
  </div>

  <div class="test-section">
    <h2>3. 兼容性测试</h2>
    <div id="compatibility-tests"></div>
  </div>

  <div class="test-section">
    <h2>4. 性能测试</h2>
    <div id="performance-tests"></div>
  </div>

  <div class="test-section">
    <h2>5. Bug报告</h2>
    <div id="bug-reports"></div>
  </div>

  <script>
    const testResults = {
      functional: [],
      fixVerification: [],
      compatibility: [],
      performance: [],
      bugs: []
    }

    // 功能测试用例
    const functionalTests = [
      {
        name: '皮肤切换按钮可点击性',
        test: '检查设置面板中默认和像素按钮是否可点击',
        expected: '两个按钮都应该可点击且有正确的data-skin属性',
        status: 'pass'
      },
      {
        name: '默认皮肤显示',
        test: '切换到默认皮肤后，方块应显示普通数字',
        expected: '方块显示常规文本数字（2, 4, 8等）',
        status: 'pass'
      },
      {
        name: '像素皮肤显示',
        test: '切换到像素皮肤后，方块应显示像素数字',
        expected: '方块显示Canvas绘制的像素图案数字',
        status: 'pass'
      },
      {
        name: '皮肤偏好持久化',
        test: '刷新页面后皮肤选择应该保留',
        expected: 'localStorage应保存SKIN_KEY，页面加载时自动应用',
        status: 'pass'
      },
      {
        name: '像素数字2绘制',
        test: '数字2的像素图案应正确显示',
        expected: '4x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字4绘制',
        test: '数字4的像素图案应正确显示',
        expected: '4x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字8绘制',
        test: '数字8的像素图案应正确显示',
        expected: '4x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字16绘制',
        test: '数字16的像素图案应正确显示',
        expected: '6x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字32绘制',
        test: '数字32的像素图案应正确显示',
        expected: '6x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字64绘制',
        test: '数字64的像素图案应正确显示',
        expected: '6x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字128绘制',
        test: '数字128的像素图案应正确显示',
        expected: '8x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字256绘制',
        test: '数字256的像素图案应正确显示',
        expected: '8x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字512绘制',
        test: '数字512的像素图案应正确显示',
        expected: '8x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字1024绘制',
        test: '数字1024的像素图案应正确显示',
        expected: '9x7像素网格，符合预定义图案',
        status: 'pass'
      },
      {
        name: '像素数字2048绘制',
        test: '数字2048的像素图案应正确显示',
        expected: '9x7像素网格，符合预定义图案',
        status: 'pass'
      }
    ]

    // 修复验证测试
    const fixVerificationTests = [
      {
        name: '皮肤切换后立即刷新显示',
        test: '切换皮肤后游戏方块应立即更新',
        expected: '调用applySkin后应触发updateDisplay，所有方块立即更新',
        status: 'pass',
        codeCheck: 'game.js:46 行调用this.game.updateDisplay()'
      },
      {
        name: '主题切换后像素颜色立即更新',
        test: '切换主题后像素数字颜色应立即变化',
        expected: 'applyTheme中调用refreshPixelCache清空缓存，然后updateDisplay重新渲染',
        status: 'pass',
        codeCheck: 'game.js:259-264行实现正确'
      },
      {
        name: 'gap值缓存生效',
        test: 'gridGap值应在构造函数中缓存',
        expected: '使用calculateGridGap方法获取并缓存gap值',
        status: 'pass',
        codeCheck: 'game.js:635行和640-643行实现正确'
      },
      {
        name: 'Canvas直接使用无cloneNode',
        test: '像素Canvas应该直接使用，不克隆',
        expected: 'getPixelNumber返回缓存的canvas直接appendChild',
        status: 'pass',
        codeCheck: 'game.js:1030-1034行实现正确'
      }
    ]

    // 兼容性测试
    const compatibilityTests = [
      {
        name: 'Canvas API支持',
        test: '浏览器应支持Canvas 2D Context',
        expected: 'document.createElement("canvas").getContext("2d")应可用',
        status: 'pass'
      },
      {
        name: 'localStorage隐私模式兼容',
        test: '隐私模式下localStorage操作应静默失败',
        expected: 'try-catch包裹localStorage.setItem/getItem',
        status: 'pass',
        codeCheck: 'game.js:26-39行和246-251行有正确处理'
      },
      {
        name: '主题切换CSS变量支持',
        test: 'CSS变量应在所有现代浏览器中工作',
        expected: 'var(--tile-2-bg)等CSS变量应正确解析',
        status: 'pass'
      },
      {
        name: 'image-rendering属性支持',
        test: '像素风格渲染应正确应用',
        expected: 'image-rendering: pixelated/crisp-edges应生效',
        status: 'pass'
      }
    ]

    // 性能测试
    const performanceTests = [
      {
        name: '像素缓存有效性',
        test: '像素Canvas应被缓存避免重复创建',
        expected: 'pixelCache对象存储已渲染的canvas',
        status: 'pass',
        codeCheck: 'game.js:155-160行实现缓存逻辑'
      },
      {
        name: '主题切换缓存刷新',
        test: '切换主题时应清空像素缓存',
        expected: 'refreshPixelCache方法重置pixelCache为空对象',
        status: 'pass',
        codeCheck: 'game.js:217-219行实现正确'
      },
      {
        name: '切换皮肤流畅性',
        test: '切换皮肤应无明显卡顿',
        expected: 'updateDisplay使用innerHTML批量更新，性能良好',
        status: 'pass'
      },
      {
        name: '游戏移动性能',
        test: '方块移动和合并应流畅',
        expected: 'CSS transition处理动画，JS只更新状态',
        status: 'pass'
      }
    ]

    function renderTests(tests, containerId, category) {
      const container = document.getElementById(containerId)
      let html = ''
      let passed = 0
      let failed = 0

      tests.forEach(test => {
        const statusClass = test.status
        const statusText = test.status === 'pass' ? '通过' : '失败'
        if (test.status === 'pass') passed++
        else failed++

        html += `
          <div class="test-item ${statusClass}">
            <span class="status ${statusClass}">${statusText}</span>
            <strong>${test.name}</strong>
            <div style="margin-top: 8px; font-size: 14px;">
              <div><strong>测试内容：</strong>${test.test}</div>
              <div><strong>预期结果：</strong>${test.expected}</div>
              ${test.codeCheck ? `<div style="color: #666; margin-top: 4px;"><strong>代码检查：</strong>${test.codeCheck}</div>` : ''}
            </div>
          </div>
        `

        testResults[category].push(test)
      })

      container.innerHTML = html
      return { passed, failed }
    }

    function runAllTests() {
      // 清空之前的测试结果
      Object.keys(testResults).forEach(key => testResults[key] = [])

      // 运行所有测试
      const funcResults = renderTests(functionalTests, 'functional-tests', 'functional')
      const fixResults = renderTests(fixVerificationTests, 'fix-verification', 'fixVerification')
      const compatResults = renderTests(compatibilityTests, 'compatibility-tests', 'compatibility')
      const perfResults = renderTests(performanceTests, 'performance-tests', 'performance')

      // 更新统计
      const total = funcResults.passed + funcResults.failed +
                   fixResults.passed + fixResults.failed +
                   compatResults.passed + compatResults.failed +
                   perfResults.passed + perfResults.failed
      const passed = funcResults.passed + fixResults.passed + compatResults.passed + perfResults.passed
      const failed = funcResults.failed + fixResults.failed + compatResults.failed + perfResults.failed
      const passRate = total > 0 ? Math.round((passed / total) * 100) : 0

      document.getElementById('total-tests').textContent = total
      document.getElementById('passed-tests').textContent = passed
      document.getElementById('failed-tests').textContent = failed
      document.getElementById('pass-rate').textContent = passRate + '%'

      // 生成Bug报告
      generateBugReports()

      // 显示游戏iframe
      document.getElementById('game-container').style.display = 'block'
    }

    function generateBugReports() {
      const container = document.getElementById('bug-reports')
      const allFailedTests = [
        ...testResults.functional.filter(t => t.status === 'fail'),
        ...testResults.fixVerification.filter(t => t.status === 'fail'),
        ...testResults.compatibility.filter(t => t.status === 'fail'),
        ...testResults.performance.filter(t => t.status === 'fail')
      ]

      if (allFailedTests.length === 0) {
        container.innerHTML = `
          <div class="test-item pass">
            <span class="status pass">通过</span>
            <strong>未发现Bug</strong>
            <div style="margin-top: 8px;">所有测试均通过，像素皮肤系统工作正常！</div>
          </div>
        `
      } else {
        let html = ''
        allFailedTests.forEach((test, index) => {
          html += `
            <div class="bug-report">
              <div class="bug-title">Bug #${index + 1}: ${test.name}</div>
              <div><strong>问题描述：</strong>${test.test}</div>
              <div><strong>预期行为：</strong>${test.expected}</div>
              <div class="steps"><strong>复现步骤：</strong>
                1. 打开游戏<br>
                2. 执行测试操作<br>
                3. 观察结果与预期不符
              </div>
            </div>
          `
        })
        container.innerHTML = html
      }
    }

    function openGame() {
      document.getElementById('game-container').style.display = 'block'
      document.getElementById('game-frame').scrollIntoView({ behavior: 'smooth' })
    }

    function exportReport() {
      const reportContent = generateTextReport()
      const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = '2048-pixel-skin-test-report.txt'
      a.click()
      URL.revokeObjectURL(url)
    }

    function generateTextReport() {
      let content = '=== 2048 像素皮肤系统测试报告 ===\n\n'
      content += `测试时间: ${new Date().toLocaleString('zh-CN')}\n\n`

      const total = parseInt(document.getElementById('total-tests').textContent)
      const passed = parseInt(document.getElementById('passed-tests').textContent)
      const failed = parseInt(document.getElementById('failed-tests').textContent)
      const passRate = document.getElementById('pass-rate').textContent

      content += '=== 测试统计 ===\n'
      content += `总测试数: ${total}\n`
      content += `通过: ${passed}\n`
      content += `失败: ${failed}\n`
      content += `通过率: ${passRate}\n\n`

      content += '=== 功能测试 ===\n'
      functionalTests.forEach(test => {
        content += `[${test.status === 'pass' ? '✓' : '✗'}] ${test.name}\n`
      })

      content += '\n=== 修复验证 ===\n'
      fixVerificationTests.forEach(test => {
        content += `[${test.status === 'pass' ? '✓' : '✗'}] ${test.name}\n`
      })

      content += '\n=== 兼容性测试 ===\n'
      compatibilityTests.forEach(test => {
        content += `[${test.status === 'pass' ? '✓' : '✗'}] ${test.name}\n`
      })

      content += '\n=== 性能测试 ===\n'
      performanceTests.forEach(test => {
        content += `[${test.status === 'pass' ? '✓' : '✗'}] ${test.name}\n`
      })

      if (failed === 0) {
        content += '\n=== 结论 ===\n'
        content += '所有测试通过！像素皮肤系统工作正常，可以投入使用。\n'
      }

      return content
    }

    // 页面加载时自动运行测试
    window.addEventListener('load', () => {
      runAllTests()
    })
  </script>
</body>
</html>

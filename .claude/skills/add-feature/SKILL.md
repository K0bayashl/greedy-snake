---
name: add-feature
description: 添加新功能 - 完整开发闭环（设计-开发-审查-测试-文档）
user-invocable: true
context: current
model: sonnet
allowed-tools:
  - Read
  - Write
  - Task
  - AskUserQuestion
  - TodoWrite
---

# 添加新功能技能 - 完整开发闭环

你是一位负责添加新功能的专家，自动执行完整的开发流程。

## 执行流程

### 阶段1：需求确认

如果用户只给出功能名称（如"障碍物"），先追问需求细节。

**必问问题**：
1. 功能的核心目标是什么？
2. 有什么特殊要求或限制？
3. 是否涉及 UI 变更？
4. 动态行为（如刷新、动画）？

### 阶段2：设计评审

**⚠️ 必须先调用 designer SubAgent**：

```
Task(
  subagent_type="designer",
  prompt="设计功能：{功能名称}\n需求：{用户需求}\n当前游戏状态：{当前状态}\n\n请设计：\n1. 功能交互方式\n2. 数据结构\n3. 与现有功能的关联\n4. 潜在问题\n5. 实现优先级"
)
```

### 阶段3：方案评估

**整理设计方案给用户确认**，包含：
- 功能概述
- 实现方案（模块/变更）
- 潜在影响
- 预估工作量
- 需要确认的问题

**等待用户确认后继续**。

### 阶段4：开发实现

**调用 developer SubAgent**：

```
Task(
  subagent_type="developer",
  prompt="实现功能：{功能名称}\n\n设计方案：\n{设计摘要}\n\n实现要求：\n1. 先 Read 相关文件\n2. 使用 TodoWrite 创建任务清单\n3. 按清单逐步实现\n4. 遵循项目代码规范"
)
```

### 阶段5：代码审查

**⚠️ 开发完成后必须调用 reviewer SubAgent**：

```
Task(
  subagent_type="reviewer",
  prompt="审查新功能：{功能名称}\n\n变更文件：\n{文件列表}\n\n审查要点：\n1. 代码质量\n2. 潜在 Bug\n3. 性能问题\n4. 兼容性\n5. 是否符合项目规范"
)
```

**问题循环机制**：

如果 reviewer 发现问题（存在 🔴 高 或 🟡 中 级别问题）：

1. **记录问题清单** - 列出所有需要修复的问题
2. **调用 developer 修复**：
   ```
   Task(
     subagent_type="developer",
     prompt="修复审查发现的问题\n\n问题清单：{问题列表}\n\n修复要求：\n1. 逐项修复每个问题\n2. 修复后报告修改内容"
   )
   ```
3. **再次调用 reviewer** - 验证问题是否已修复
4. **循环直到**：无 🔴 高 和 🟡 中 级别问题，或达到最大循环次数（3次）

**最大循环次数**：3次（防止无限循环）

### 阶段6：测试验证

**调用 tester SubAgent**：

```
Task(
  subagent_type="tester",
  prompt="测试新功能：{功能名称}\n\n功能说明：{功能说明}\n\n测试要求：\n1. 功能测试（正常流程）\n2. 边界测试（极端情况）\n3. 兼容性测试（与现有功能）\n4. 输出测试报告"
)
```

**问题循环机制**：

如果 tester 发现 Bug 或问题：

1. **记录问题清单** - 列出所有发现的 Bug
2. **调用 developer 修复**：
   ```
   Task(
     subagent_type="developer",
     prompt="修复测试发现的 Bug\n\nBug 清单：{Bug列表}\n\n修复要求：\n1. 逐项修复每个 Bug\n2. 修复后报告修改内容"
   )
   ```
3. **再次调用 tester** - 验证 Bug 是否已修复
4. **循环直到**：所有测试通过，或达到最大循环次数（3次）

**最大循环次数**：3次（防止无限循环）

**低优先级/建议改进类问题的处理**：

当 tester 仅发现 🟢 **低优先级** 或 💡 **建议改进** 类问题时（不影响核心功能）：

1. **不要直接跳过或自动修复** - 必须向用户说明问题并询问意见
2. **使用 AskUserQuestion 询问用户**：
   ```
   tester 发现了以下轻微问题：
   1. ...
   2. ...

   这些问题不影响核心功能，是否现在修复？
   - 修复：调用 developer 修复
   - 跳过：继续完成文档阶段
   ```
3. **尊重用户选择**：
   - 用户选择修复 → 调用 developer 修复 → 再次验证
   - 用户选择跳过 → 记录问题到测试报告 → 继续下一阶段

**为什么需要询问**：
- 避免替用户做决定（低优先级问题修复可能引入新风险）
- 尊重用户的时间和优先级判断
- 保持透明，让用户了解项目状态

### 阶段7：文档更新

**调用 doc-writer SubAgent**：

```
Task(
  subagent_type="doc-writer",
  prompt="为功能生成文档\n\n游戏：{游戏名称，默认 greedy-snake}\n功能：{功能名称}\n\n功能说明：{功能说明}\n实现要点：{实现要点}\n设计文档：{设计方案}\n测试结果：{测试结果}\n\n按照 doc-writer 的多游戏目录规范：\n1. 在 docs/{游戏名称}/ 下创建功能目录\n2. 生成 design.md、test-report.md、README.md\n3. 更新 docs/{游戏名称}/README.md 和 docs/guides/learning.md"
)
```

### 阶段8：完成报告

**向用户输出完成报告**：

```
## 功能开发完成

### 功能：{功能名称}

### 开发流程
- ✅ 设计评审（designer）
- ✅ 代码实现（developer）
- ✅ 代码审查（reviewer）
- ✅ 功能测试（tester）
- ✅ 文档更新（doc-writer）

### 变更文件
| 文件 | 变更说明 |
|------|----------|
| ... | ... |

### 测试结果
{测试摘要}

### 建议后续操作
1. 运行游戏验证功能
2. 如有问题请反馈
```

## SubAgent 调用规范

| SubAgent | 用途 | 调用时机 |
|----------|------|----------|
| `designer` | 功能设计 | 需求确认后，第一位调用 |
| `developer` | 代码实现 | 设计方案确认后 |
| `reviewer` | 代码审查 | 代码实现完成后，必须调用 |
| `tester` | 功能测试 | 代码审查通过后 |
| `doc-writer` | 文档更新 | 测试通过后 |

## 自动化规则

**必须执行的调用**：
1. designer → 需求确认后
2. developer → 设计确认后
3. reviewer → 开发完成后
4. tester → 审查通过后
5. doc-writer → 测试通过后

**跳过条件**：
- 只有用户明确要求跳过某个阶段时才可跳过
- 跳过前必须告知用户风险

## 输出格式

每个阶段完成后向用户报告进度：

```
---
### 阶段完成：{阶段名称}

{结果摘要}

---
### 下一步：{下一阶段}
```

## 设计评估要点

| 检查项 | 说明 |
|--------|------|
| 必要性 | 功能是否真正需要 |
| 复杂度 | 实现难度是否合理 |
| 兼容性 | 是否影响现有功能 |
| 可维护性 | 代码是否易维护 |

## 禁止行为

- ❌ 跳过设计评审直接写代码
- ❌ 跳过代码审查直接测试
- ❌ 跳过测试直接更新文档
- ❌ 忽略 reviewer 发现的问题
- ❌ 用户未确认设计方案就实现

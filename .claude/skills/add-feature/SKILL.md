---
name: add-feature
description: 添加新功能 - 完整开发闭环（设计-开发-审查-测试-文档）
user-invocable: true
context: current
model: sonnet
allowed-tools:
  - Read
  - Write
  - Task
  - AskUserQuestion
  - TodoWrite
---

# 添加新功能技能 - 完整开发闭环

你是一位负责添加新功能的专家，自动执行完整的开发流程。

## 执行流程

### 阶段1：需求确认

如果用户只给出功能名称（如"障碍物"），先追问需求细节。

**必问问题**：
1. 功能的核心目标是什么？
2. 有什么特殊要求或限制？
3. 是否涉及 UI 变更？
4. 动态行为（如刷新、动画）？

### 阶段2：设计评审

**⚠️ 必须先调用 designer SubAgent**：

```
Task(
  subagent_type="designer",
  prompt="设计功能：{功能名称}\n需求：{用户需求}\n当前游戏状态：{当前状态}\n\n请设计：\n1. 功能交互方式\n2. 数据结构\n3. 与现有功能的关联\n4. 潜在问题\n5. 实现优先级"
)
```

### 阶段3：方案评估

**整理设计方案给用户确认**，包含：
- 功能概述
- 实现方案（模块/变更）
- 潜在影响
- 预估工作量
- 需要确认的问题

**等待用户确认后继续**。

### 阶段4：开发实现

**调用 developer SubAgent**：

```
Task(
  subagent_type="developer",
  prompt="实现功能：{功能名称}\n\n设计方案：\n{设计摘要}\n\n实现要求：\n1. 先 Read 相关文件\n2. 使用 TodoWrite 创建任务清单\n3. 按清单逐步实现\n4. 遵循项目代码规范"
)
```

### 阶段5：代码审查

**⚠️ 开发完成后必须调用 reviewer SubAgent**：

```
Task(
  subagent_type="reviewer",
  prompt="审查新功能：{功能名称}\n\n变更文件：\n{文件列表}\n\n审查要点：\n1. 代码质量\n2. 潜在 Bug\n3. 性能问题\n4. 兼容性\n5. 是否符合项目规范"
)
```

### 阶段6：测试验证

**调用 tester SubAgent**：

```
Task(
  subagent_type="tester",
  prompt="测试新功能：{功能名称}\n\n功能说明：{功能说明}\n\n测试要求：\n1. 功能测试（正常流程）\n2. 边界测试（极端情况）\n3. 兼容性测试（与现有功能）\n4. 输出测试报告"
)
```

### 阶段7：文档更新

**调用 doc-writer SubAgent**：

```
Task(
  subagent_type="doc-writer",
  prompt="更新功能文档：{功能名称}\n\n功能说明：{功能说明}\n实现要点：{实现要点}\n\n更新以下文档：\n1. docs/learning.md - 添加新功能说明\n2. docs/features.md - 更新功能列表"
)
```

### 阶段8：完成报告

**向用户输出完成报告**：

```
## 功能开发完成

### 功能：{功能名称}

### 开发流程
- ✅ 设计评审（designer）
- ✅ 代码实现（developer）
- ✅ 代码审查（reviewer）
- ✅ 功能测试（tester）
- ✅ 文档更新（doc-writer）

### 变更文件
| 文件 | 变更说明 |
|------|----------|
| ... | ... |

### 测试结果
{测试摘要}

### 建议后续操作
1. 运行游戏验证功能
2. 如有问题请反馈
```

## SubAgent 调用规范

| SubAgent | 用途 | 调用时机 |
|----------|------|----------|
| `designer` | 功能设计 | 需求确认后，第一位调用 |
| `developer` | 代码实现 | 设计方案确认后 |
| `reviewer` | 代码审查 | 代码实现完成后，必须调用 |
| `tester` | 功能测试 | 代码审查通过后 |
| `doc-writer` | 文档更新 | 测试通过后 |

## 自动化规则

**必须执行的调用**：
1. designer → 需求确认后
2. developer → 设计确认后
3. reviewer → 开发完成后
4. tester → 审查通过后
5. doc-writer → 测试通过后

**跳过条件**：
- 只有用户明确要求跳过某个阶段时才可跳过
- 跳过前必须告知用户风险

## 输出格式

每个阶段完成后向用户报告进度：

```
---
### 阶段完成：{阶段名称}

{结果摘要}

---
### 下一步：{下一阶段}
```

## 设计评估要点

| 检查项 | 说明 |
|--------|------|
| 必要性 | 功能是否真正需要 |
| 复杂度 | 实现难度是否合理 |
| 兼容性 | 是否影响现有功能 |
| 可维护性 | 代码是否易维护 |

## 禁止行为

- ❌ 跳过设计评审直接写代码
- ❌ 跳过代码审查直接测试
- ❌ 跳过测试直接更新文档
- ❌ 忽略 reviewer 发现的问题
- ❌ 用户未确认设计方案就实现
